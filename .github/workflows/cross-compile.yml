# Publish Compiler binaries

name: Cross compile

on:
  push:
    paths:
      #- 'compiler/cpp/**'
  pull_request:
    branches: [ main, dev, feature/* ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch_name: [linux-arm64, linux-armv5, linux-armv6, linux-armv7, linux-x86, linux-x64, windows-static-x86, windows-static-x64]
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      
      - name: Prepare builder
        run: |
          docker run --rm dockcross/${{ matrix.arch_name }} > ./dockcross
          chmod +x dockcross
          mkdir bin
      
      - name: Configure
        run: ./dockcross cmake -Bbin -H./compiler/cpp -GNinja

      - name: Compile
        run: ./dockcross ninja -Cbin

      - name: Process build output - Linux
        if: ${{ startsWith(matrix.arch_name, 'linux') }}
        working-directory: bin
        run: |
          mv compiler ccomc
          chmod +x ccomc
          
      - name: Process build output - Windows
        if: ${{ startsWith(matrix.arch_name, 'windows') }}
        working-directory: bin
        run: mv compiler ccomc.exe

      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: ccom-${{ matrix.arch_name }}
          path: ./bin/ccom**